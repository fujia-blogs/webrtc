# 端对端连接

1. A 和 B 要通信，基本流程如下：

- A 和 B 媒体协商，检查各自的媒体能力，取一个交集，即两端都支持的媒体能力，如：编解码，采样率，帧率等；
- candidate 交换、连接和检测，找到两端可以连接的最优通路；
- 媒体和数据流的通信。

详细的时序图如下：

![p2p-process](../assets/images/p2p-process.jpg)

## RTCPeerConnection

1. 它是 WebRTC 的核心类，是上层的统一接口，在底层做了非常复杂的封装，包括：媒体协商，流和轨道的处理，接收和发送以及统计数据等。

2. 语法格式：

```ts
const pc = new RTCPeerConnection([configuration]);
```

### 方法

#### 媒体协商

1. 媒体协商过程

![media-consultation](../assets/images/media-consultation.jpg)

1.1 Amy

- 创建一个 Offer，创建成功之后就形成一个 SDP;
- 调用 setLocalDescription，该方法会触发收集 candidate
- 通过云端 signaling channel 传给对端；

- 收到 Bob 的 answer 之后，调用 setRemoteDescription 将相关数据存储在远程槽中。

  1.2 Bob

- 收到 Amy 传过来的 Offer 之后，调用 setRemoteDescription，将 offer 形成的 SDP 数据存储在自己的相关对象(槽)中；
- 回一个 Answer，即本身的媒体信息和网络信息；
- 调用 setLocalDescription，该方法会触发收集 candidate

tips:

- 每一端都有两个 SDP，一个是自己的媒体信息，另一个是连接端的媒体信息；

2. createOffer

语法：

```js
const offer = await myPeerConnection.createOffer([options]);
```

3. createAnswer

语法：

```js
const answer = await myPeerConnection.createAnswer([options]);
```

4. setLocalDescription

语法：

```js
const ld = await myPeerConnection.setLocalDescription(sessionDescription);
```

5. setRemoteDescription

语法：

```js
const ld = await myPeerConnection.setRemoteDescription(sessionDescription);
```

#### stream/track

1. addTrack

语法：

```js
myPeerConnection.addTrack(track, stream);
```

2. remoteTrack

语法：

```js
myPeerConnection.remoteTrack(rtpSender);
```

#### 传输相关方法

#### 统计相关方法

### 事件

1. 协商事件 - onnegotiationneeded

2. onicecandidate - 收到一个协商者时触发
